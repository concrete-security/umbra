name: CVM Tests

on:
  pull_request:
    paths:
      - "cvm/**"
  push:
    branches:
      - main
    paths:
      - "cvm/**"

jobs:
  cvm-tests:
    name: Run CVM Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Install uv
        uses: astral-sh/setup-uv@2ddd2b9cb38ad8efd50337e8ab201519a34c9f24 # v3

      - name: Install Python dependencies
        working-directory: ./cvm
        run: |
          uv venv
          uv pip install -r requirements_test.txt

      - name: Start CVM services and wait (dev mode)
        working-directory: ./cvm
        run: |
          make dev-up
          make wait-services

      - name: Run CVM tests (dev mode)
        working-directory: ./cvm
        run: make test-all

      - name: Show service logs on failure
        if: failure()
        working-directory: ./cvm
        run: |
          echo "=== Service Logs ==="
          make logs
          echo "=== Docker Compose Status ==="
          docker compose -f docker-compose.yml -f docker-compose.dev.override.yml ps

      - name: Cleanup services
        if: always()
        working-directory: ./cvm
        run: make dev-down
